<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ú–æ—ó –≤—ñ—Ä—à—ñ</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Roboto:wght@300;400;500&family=Dancing+Script:wght@400;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ */
    :root {
      --primary: #6b5b45;
      --secondary: #e1c9a6;
      --light: #f8f1e5;
      --dark: #3a2e20;
      --accent: #8b7355;
      --transition: all 0.4s cubic-bezier(0.65, 0, 0.35, 1);
      --current-font: "'Playfair Display', serif";
      --safe-area-top: env(safe-area-inset-top, 20px);
      --safe-area-bottom: env(safe-area-inset-bottom, 20px);
      --safe-area-left: env(safe-area-inset-left, 10px);
      --safe-area-right: env(safe-area-inset-right, 10px);
    }

    /* –ê–Ω—ñ–º–∞—Ü—ñ—ó */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes float {
      0% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(5deg); }
      100% { transform: translateY(0px) rotate(0deg); }
    }
    @keyframes mark {
      0% { background: radial-gradient(#3333333d 0%, #33333300 35%); }
      50% { background: radial-gradient(#3333333d 0%, #33333300 35%); }
      75% { background: radial-gradient(var(--primary) 35%, var(--dark) 60%); }
      100% { background: radial-gradient(var(--primary) 65%, var(--dark) 100%); }
    }
    @keyframes unmark {
      0% { background: radial-gradient(var(--primary) 65%, var(--dark) 100%); }
      50% { background: linear-gradient(#ffffff 35%, var(--light) 60%); }
      100% { background: radial-gradient(#ffffff 30%, var(--light) 100%); }
    }
    @keyframes falling {
      0% { 
        transform: translate(calc(-10px + (20px * var(--random))), -10%) rotate(0deg); 
        opacity: 0; 
      }
      10% { opacity: 0.8; }
      100% { 
        transform: translate(calc(10px + (80px * var(--random))), 100vh) rotate(calc(360deg * var(--random)));
        opacity: 0; 
      }
    }
    @keyframes pulseGlow {
      0%, 100% { 
        box-shadow: 0 0 5px rgba(139, 115, 85, 0.3);
      }
      50% { 
        box-shadow: 0 0 15px rgba(139, 115, 85, 0.6), 0 0 25px rgba(139, 115, 85, 0.4);
      }
    }

    /* –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: var(--current-font);
      background: url('–§–æ–Ω –¥–ª—è –≤—ñ—Ä—à—ñ–≤.png') no-repeat center center fixed;
      background-size: cover;
      color: var(--dark);
      min-height: 100dvh;
      overflow-x: hidden;
      transition: var(--transition);
      position: relative;
    }

    /* –ü–∞–¥–∞—é—á—ñ –ø–µ–ª—é—Å—Ç–∫–∏ */
    .petal {
      position: fixed;
      top: -10%;
      z-index: 9999;
      pointer-events: none;
      user-select: none;
      will-change: transform;
      animation: falling linear infinite;
      opacity: 0.7;
    }

    /* –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" */
    .back-btn-container {
      position: fixed;
      top: calc(var(--safe-area-top) + 20px);
      left: calc(var(--safe-area-left) + 20px);
      z-index: 1001;
      width: 120px;
    }
    .back-btn {
      display: flex;
      height: 2.5em;
      width: 100%;
      align-items: center;
      justify-content: center;
      border-radius: 15px;
      letter-spacing: 1px;
      transition: var(--transition);
      cursor: pointer;
      border: none;
      background-color: var(--primary);
      color: var(--light);
      padding: 0 15px;
      font-family: inherit;
      font-size: 1rem;
      gap: 8px;
    }
    .back-btn:hover {
      background-color: #7a5c3c;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transform: translateY(-2px);
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
    .header-title {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      color: var(--light);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      z-index: 1000;
      font-weight: 700;
      letter-spacing: 1px;
      padding: 15px 0;
      text-align: center;
      background: linear-gradient(to right, var(--primary), var(--accent));
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      padding-left: var(--safe-area-left);
      padding-right: var(--safe-area-right);
    }

    /* –û—Å–Ω–æ–≤–Ω–µ –º–µ–Ω—é (–ø–æ—à—É–∫ —ñ —Å–ø–∏—Å–æ–∫ –≤—ñ—Ä—à—ñ–≤) */
    .main-menu {
      margin-top: 70px;
      padding: 20px;
      background: rgba(225, 201, 166, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      max-height: 40dvh;
      overflow-y: auto;
      margin: 70px 20px 10px 20px;
      border: 1px solid rgba(107, 91, 69, 0.2);
    }

    /* –ü–æ—à—É–∫ */
    .search-container {
      margin-bottom: 15px;
    }
    .search-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 25px;
      border: 1px solid var(--secondary);
      background: rgba(255,255,255,0.8);
      font-family: inherit;
      font-size: 1rem;
    }
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(107, 91, 69, 0.1);
    }

    /* –°–ø–∏—Å–æ–∫ –≤—ñ—Ä—à—ñ–≤ */
    .poems-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .poem-item {
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1.05rem;
      border: 1px solid rgba(107, 91, 69, 0.1);
    }
    .poem-item:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .poem-item.active {
      background: rgba(139, 115, 85, 0.3);
      border-left: 4px solid var(--primary);
      font-weight: 600;
    }

    /* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞—É–¥—ñ–æ */
    .poem-item.playing {
      animation: pulseGlow 2s ease-in-out infinite;
      border-left: 4px solid var(--accent);
    }

    /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s ease;
    }
    .modal.open {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: rgba(248, 241, 229, 0.98);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      width: 90%;
      max-width: 800px;
      max-height: 90dvh;
      overflow-y: auto;
      padding: 30px;
      position: relative;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      transform: scale(0.95);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      border: 1px solid rgba(107, 91, 69, 0.2);
    }
    .modal.open .modal-content {
      transform: scale(1);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--secondary);
      padding-bottom: 10px;
    }
    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--dark);
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.8rem;
      color: var(--dark);
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }
    .modal-close:hover {
      background: rgba(0,0,0,0.1);
    }

    /* –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤—ñ—Ä—à–∞ */
    .poem-display-content {
      font-size: 1.1rem;
      line-height: 1.8;
      color: #333;
      white-space: pre-line;
      text-align: center;
      hyphens: auto;
    }
    .poem-display-content p {
      margin: 10px 0;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.4s ease forwards;
      animation-delay: calc(var(--i) * 0.1s);
    }

    /* –ö–Ω–æ–ø–∫–∏ —É –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ */
    .poem-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }
    .poem-action-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background-color: var(--primary);
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
    }
    .poem-action-btn:hover {
      background-color: #8b7355;
      transform: translateY(-2px);
    }
    .poem-action-btn.cancel {
      background-color: #ccc;
      color: #333;
    }
    .poem-action-btn.cancel:hover {
      background-color: #bbb;
    }

    /* –í–∏–±—ñ—Ä —à—Ä–∏—Ñ—Ç—É */
    .font-selector {
      position: fixed;
      bottom: calc(20px + var(--safe-area-bottom));
      right: calc(20px + var(--safe-area-right));
      background: rgba(107, 91, 69, 0.9);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: var(--transition);
      backdrop-filter: blur(5px);
    }
    .font-selector:hover {
      transform: scale(1.1);
      background-color: #8b7355;
    }

    /* –ö–Ω–æ–ø–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤—ñ—Ä—à–∞ */
    .add-poem-btn {
      position: fixed;
      bottom: calc(20px + var(--safe-area-bottom));
      left: calc(20px + var(--safe-area-left));
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: var(--transition);
    }
    .add-poem-btn:hover {
      transform: scale(1.1);
      background-color: #8b7355;
    }

    /* –ö–æ–Ω—Ç—Ä–æ–ª—å –≥—É—á–Ω–æ—Å—Ç—ñ */
    .volume-control {
      position: fixed;
      top: calc(var(--safe-area-top) + 20px);
      right: calc(var(--safe-area-right) + 20px);
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(107, 91, 69, 0.8);
      padding: 5px 10px;
      border-radius: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .volume-icon {
      color: var(--light);
      width: 20px;
      height: 20px;
    }
    .volume-slider {
      width: 100px;
      height: 5px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--light);
      outline: none;
      border-radius: 5px;
      opacity: 0.7;
      transition: var(--transition);
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: var(--light);
      cursor: pointer;
    }

    /* –ú–µ–Ω—é –≤–∏–±–æ—Ä—É —à—Ä–∏—Ñ—Ç—ñ–≤ */
    .font-options {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: rgba(107, 91, 69, 0.95);
      border-radius: 10px;
      padding: 15px;
      width: 200px;
      z-index: 1000;
      transform: translateY(10px);
      opacity: 0;
      pointer-events: none;
      transition: var(--transition);
      backdrop-filter: blur(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .font-options.show {
      transform: translateY(0);
      opacity: 1;
      pointer-events: all;
    }
    .font-option {
      padding: 8px 12px;
      color: var(--light);
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 5px;
      transition: var(--transition);
      font-size: 0.95rem;
    }
    .font-option:hover {
      background: rgba(225, 201, 166, 0.3);
    }
    .font-option.active {
      background: rgba(225, 201, 166, 0.5);
      font-weight: 500;
    }

    /* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
    .loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: var(--secondary);
      z-index: 2001;
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        padding: 20px;
      }
      .main-menu {
        padding: 15px;
        margin: 70px 10px 10px 10px;
      }
      .search-input {
        font-size: 0.95rem;
      }
      .poem-item {
        font-size: 0.95rem;
        padding: 10px 12px;
      }
      .volume-control {
        top: calc(var(--safe-area-top) + 12px);
        right: calc(var(--safe-area-right) + 10px);
        padding: 4px 8px;
      }
      .volume-slider {
        width: 70px;
      }
      .add-poem-btn, .font-selector {
        bottom: calc(var(--safe-area-bottom) + 20px);
      }
      .add-poem-btn {
        left: calc(var(--safe-area-left) + 20px);
      }
      .font-selector {
        right: calc(var(--safe-area-right) + 20px);
      }
    }

    @media (max-width: 480px) {
      .modal-content {
        width: 98%;
        padding: 15px;
      }
      .modal-title {
        font-size: 1.3rem;
      }
      .poem-display-content {
        font-size: 1.05rem;
      }
      .poem-action-btn {
        padding: 8px 16px;
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <!-- –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
  <div class="loader" id="loader"></div>

  <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
  <div class="back-btn-container">
    <button class="back-btn" onclick="window.history.back()">
      <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024"><path d="M874.690416 495.52477c0 11.2973-9.168824 20.466124-20.466124 20.466124l-604.773963 0 188.083679 188.083679c7.992021 7.992021 7.992021 20.947078 0 28.939099-4.001127 3.990894-9.240455 5.996574-14.46955 5.996574-5.239328 0-10.478655-1.995447-14.479783-5.996574l-223.00912-223.00912c-3.837398-3.837398-5.996574-9.046027-5.996574-14.46955 0-5.433756 2.159176-10.632151 5.996574-14.46955l223.019353-223.029586c7.992021-7.992021 20.957311-7.992021 28.949332 0 7.992021 8.002254 7.992021 20.957311 0 28.949332l-188.073446 188.073446 604.753497 0C865.521592 475.058646 874.690416 484.217237 874.690416 495.52477z"></path></svg>
      <span>–ù–∞–∑–∞–¥</span>
    </button>
  </div>

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="header-title">–ú–æ—ó –≤—ñ—Ä—à—ñ</div>

  <!-- –ö–æ–Ω—Ç—Ä–æ–ª—å –≥—É—á–Ω–æ—Å—Ç—ñ -->
  <div class="volume-control">
    <svg class="volume-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
    </svg>
    <input type="range" min="0" max="1" step="0.01" value="0.7" class="volume-slider" id="volumeSlider">
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–µ –º–µ–Ω—é (–ø–æ—à—É–∫ —ñ –≤–∏–±—ñ—Ä –≤—ñ—Ä—à—ñ–≤) -->
  <div class="main-menu">
    <div class="search-container">
      <input type="text" class="search-input" id="poemSearch" placeholder="–ü–æ—à—É–∫ –≤—ñ—Ä—à—ñ–≤...">
    </div>
    <div class="poems-list" id="poemsList">
      <!-- –í—ñ—Ä—à—ñ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ —Ç—É—Ç -->
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤—ñ—Ä—à–∞ -->
  <div class="add-poem-btn" id="addPoemBtn">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
  </div>

  <!-- –í–∏–±—ñ—Ä —à—Ä–∏—Ñ—Ç—É -->
  <div class="font-selector" id="fontSelector">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 7V4h16v3"></path>
      <path d="M5 20h6"></path>
      <path d="M13 4 8 20"></path>
      <path d="m15 15 5 5"></path>
      <path d="m20 15-5 5"></path>
    </svg>
  </div>
  <div class="font-options" id="fontOptions">
    <div class="font-option active" data-font="'Playfair Display', serif">–ï–ª–µ–≥–∞–Ω—Ç–Ω–∏–π</div>
    <div class="font-option" data-font="'Roboto', sans-serif">–°—É—á–∞—Å–Ω–∏–π</div>
    <div class="font-option" data-font="'Dancing Script', cursive">–†—É–∫–æ–ø–∏—Å–Ω–∏–π</div>
    <div class="font-option" data-font="'Courier Prime', monospace">–ú–æ–Ω–æ–ü—Ä–æ—Å—Ç—ñ—Ä</div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –≤—ñ—Ä—à–∞ -->
  <div class="modal" id="poemModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">–ù–∞–∑–≤–∞ –≤—ñ—Ä—à–∞</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="poem-display-content" id="modalContent"></div>
      <div class="poem-actions">
        <button class="poem-action-btn" id="editPoemBtnModal">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
        <button class="poem-action-btn" id="deletePoemBtnModal">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        <button class="poem-action-btn cancel" onclick="closeModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ä–º–∏ -->
  <div class="modal" id="formModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="formModalTitle">–î–æ–¥–∞—Ç–∏ –≤—ñ—Ä—à</h2>
        <button class="modal-close" onclick="closeFormModal()">&times;</button>
      </div>
      <div class="form-group">
        <label for="poemTitle" class="form-label">–ù–∞–∑–≤–∞ –≤—ñ—Ä—à–∞:</label>
        <input type="text" id="poemTitle" class="form-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É">
      </div>
      <div class="form-group">
        <label for="poemText" class="form-label">–¢–µ–∫—Å—Ç –≤—ñ—Ä—à–∞:</label>
        <textarea id="poemText" class="form-textarea" placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç"></textarea>
      </div>
      <div class="form-group">
        <label for="audioUpload" class="form-label">–ê—É–¥—ñ–æ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ):</label>
        <input type="file" id="audioUpload" accept="audio/*" class="form-input">
      </div>
      <div class="poem-actions">
        <button class="poem-action-btn cancel" onclick="closeFormModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="poem-action-btn" id="submitForm">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- Firebase —Ç–∞ Supabase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
    let currentPoemId = null;
    let db = null;
    let supabaseClient = null;
    let currentlyPlayingAudio = null;
    let allPoems = [];

    const supabaseUrl = 'https://ijwojkwbecpmeyhpnrtf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlqd29qa3diZWNwbWV5aHBucnRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0Nzc4ODAsImV4cCI6MjA2OTA1Mzg4MH0.qpl5HHifUdLLpoVGuTZfJPr8ggLGpFiskZ3-90RykYs';

    // Lazy loading –∞—É–¥—ñ–æ
    const lazyLoadAudio = (audioElement) => {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !entry.target.src && entry.target.dataset.src) {
            entry.target.src = entry.target.dataset.src;
            entry.target.load();
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1 });
      observer.observe(audioElement);
    };

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase
    async function initializeFirebase() {
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyDcTBQCxTy9-ZC4-2Tj_wbkAQPlOz9iddU",
          authDomain: "my-poetry-app-db824.firebaseapp.com",
          projectId: "my-poetry-app-db824",
          messagingSenderId: "623904628586",
          appId: "1:623904628586:web:510f46ba1ae9ba9c4bcf13"
        };
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        return true;
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase:", error);
        return false;
      }
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Supabase
    async function initializeSupabase() {
      try {
        supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        const { data: buckets, error: bucketsError } = await supabaseClient.storage.listBuckets();

        if (bucketsError) {
          console.error("–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ —Å—Ö–æ–≤–∏—â–∞:", bucketsError);
          throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Å—Ö–æ–≤–∏—â–∞");
        }

        // –ë–µ–∑–ø–µ—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
        if (!buckets || !Array.isArray(buckets)) {
          console.warn("–°–ø–∏—Å–æ–∫ –±–∞–∫–µ—Ç—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π –∞–±–æ –Ω–µ —î –º–∞—Å–∏–≤–æ–º");
          return true;
        }

        const bucketExists = buckets.some(b => b.name === 'poetry-audio');
        if (!bucketExists) {
          console.warn('–ë–∞–∫–µ—Ç "poetry-audio" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤—ñ–Ω —Å—Ç–≤–æ—Ä–µ–Ω–∏–π —É Supabase.');
        }

        return true;
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Supabase:", error.message);
        return false;
      }
    }

    // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–µ–ª—é—Å—Ç–æ–∫
    function createPetals() {
      const petals = ['üå∏', 'üçÄ', 'üåπ', 'üåº', 'üå∫', 'üçÅ'];
      const container = document.body;
      for (let i = 0; i < 15; i++) {
        const petal = document.createElement('div');
        petal.className = 'petal';
        petal.innerHTML = petals[Math.floor(Math.random() * petals.length)];
        const random = Math.random();
        petal.style.setProperty('--random', random);
        petal.style.left = `${random * 100}%`;
        petal.style.fontSize = (Math.random() * 15 + 10) + 'px';
        petal.style.animationDuration = `${5 + random * 10}s`;
        petal.style.animationDelay = `${random * 5}s`;
        container.appendChild(petal);
      }
    }

    // –ú–æ–¥–∞–ª–∫–∏
    function showModal(modalId) {
      document.getElementById(modalId).classList.add('open');
    }
    function closeModal() {
      document.getElementById('poemModal').classList.remove('open');
      stopCurrentAudio();
    }
    function closeFormModal() {
      document.getElementById('formModal').classList.remove('open');
      document.getElementById('poemTitle').value = '';
      document.getElementById('poemText').value = '';
      document.getElementById('audioUpload').value = '';
    }

    // –ó—É–ø–∏–Ω–∏—Ç–∏ –∞—É–¥—ñ–æ
    function stopCurrentAudio() {
      if (currentlyPlayingAudio) {
        currentlyPlayingAudio.pause();
        currentlyPlayingAudio = null;
      }
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ—Ä—à—ñ
    async function loadPoems() {
      showLoader();
      try {
        const snapshot = await db.collection('poems').orderBy('createdAt', 'desc').get();
        const poemsList = document.getElementById('poemsList');
        poemsList.innerHTML = '';
        allPoems = [];

        if (snapshot.empty) {
          poemsList.innerHTML = '<div style="text-align:center; padding:10px; color:#666;">–ù–µ–º–∞—î –≤—ñ—Ä—à—ñ–≤</div>';
          return;
        }

        snapshot.forEach(doc => {
          const poem = doc.data();
          poem.id = doc.id;
          allPoems.push(poem);

          const item = document.createElement('div');
          item.className = 'poem-item';
          item.textContent = poem.title;
          item.dataset.poemId = doc.id;
          item.onclick = () => openPoemModal(doc.id);

          if (poem.audioUrl) {
            const audio = document.createElement('audio');
            audio.id = `${doc.id}-audio`;
            audio.dataset.src = poem.audioUrl;
            audio.preload = 'none';
            item.appendChild(audio);
            lazyLoadAudio(audio);
          }

          poemsList.appendChild(item);
        });

        setupSearch();
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ—Ä—à—ñ–≤:", error);
        showError("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ—Ä—à—ñ.");
      } finally {
        hideLoader();
      }
    }

    // –ü–æ—à—É–∫
    function setupSearch() {
      const searchInput = document.getElementById('poemSearch');
      searchInput.addEventListener('input', () => {
        const term = searchInput.value.toLowerCase();
        document.querySelectorAll('.poem-item').forEach(item => {
          const title = item.textContent.toLowerCase();
          item.style.display = title.includes(term) ? '' : 'none';
        });
      });
    }

    // –í—ñ–¥–∫—Ä–∏—Ç–∏ –≤—ñ—Ä—à —É –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ
    function openPoemModal(poemId) {
      const poem = allPoems.find(p => p.id === poemId);
      if (!poem) return;

      document.getElementById('modalTitle').textContent = poem.title;
      const content = document.getElementById('modalContent');
      content.innerHTML = '';
      const lines = poem.text.split('\n');
      lines.forEach((line, i) => {
        if (line.trim() === '') return;
        const p = document.createElement('p');
        p.textContent = line;
        p.style.setProperty('--i', i);
        content.appendChild(p);
      });

      currentPoemId = poemId;

      // –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞—É–¥—ñ–æ
      const audio = document.getElementById(`${poemId}-audio`);
      if (audio && audio.dataset.src) {
        audio.volume = document.getElementById('volumeSlider').value;
        audio.currentTime = 0;
        currentlyPlayingAudio = audio;
        audio.onplay = () => {
          const item = document.querySelector(`.poem-item[data-poem-id="${poemId}"]`);
          if (item) item.classList.add('playing');
        };
        audio.onpause = () => {
          const item = document.querySelector(`.poem-item[data-poem-id="${poemId}"]`);
          if (item) item.classList.remove('playing');
        };
        audio.onended = () => {
          const item = document.querySelector(`.poem-item[data-poem-id="${poemId}"]`);
          if (item) item.classList.remove('playing');
        };
        try {
          audio.play().catch(e => {
            const playButton = document.createElement('button');
            playButton.textContent = '‚ñ∂ –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –∞—É–¥—ñ–æ';
            playButton.className = 'poem-action-btn';
            playButton.style.margin = '20px auto';
            playButton.style.display = 'block';
            playButton.onclick = () => {
              audio.play().then(() => {
                playButton.remove();
              }).catch(err => {
                showError("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –∞—É–¥—ñ–æ: " + err.message);
              });
            };
            content.appendChild(playButton);
          });
        } catch (e) {
          console.log("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∞—É–¥—ñ–æ:", e);
        }
      }

      showModal('poemModal');
    }

    // –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ–æ—Ä–º—É
    function openFormModal(isEdit = false) {
      if (isEdit) {
        const poem = allPoems.find(p => p.id === currentPoemId);
        if (poem) {
          document.getElementById('formModalTitle').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤—ñ—Ä—à';
          document.getElementById('poemTitle').value = poem.title;
          document.getElementById('poemText').value = poem.text;
        }
      } else {
        document.getElementById('formModalTitle').textContent = '–î–æ–¥–∞—Ç–∏ –≤—ñ—Ä—à';
        document.getElementById('poemTitle').value = '';
        document.getElementById('poemText').value = '';
      }
      showModal('formModal');
    }

    // –ó–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ—Ä—à
    async function savePoem() {
      const title = document.getElementById('poemTitle').value.trim();
      const text = document.getElementById('poemText').value.trim();
      const audioFile = document.getElementById('audioUpload').files[0];
      const isEdit = !!currentPoemId;

      if (!title || !text) {
        showError('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ —Ç–µ–∫—Å—Ç –≤—ñ—Ä—à–∞');
        return;
      }

      showLoader();
      try {
        let audioUrl = '';
        if (audioFile) {
          if (audioFile.size > 5 * 1024 * 1024) {
            showError('–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π (–º–∞–∫—Å. 5MB)');
            hideLoader();
            return;
          }
          const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/ogg'];
          if (!allowedTypes.includes(audioFile.type)) {
            showError('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ MP3, WAV –∞–±–æ OGG');
            hideLoader();
            return;
          }

          try {
            audioUrl = await uploadAudio(audioFile);
          } catch (error) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—É–¥—ñ–æ:", error);
            showError("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞—É–¥—ñ–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ–ª—ñ—Ç–∏–∫–∏ –≤ Supabase.");
            hideLoader();
            return;
          }
        }

        const data = { title, text };
        if (audioUrl) data.audioUrl = audioUrl;

        if (isEdit) {
          await db.collection('poems').doc(currentPoemId).update(data);
        } else {
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('poems').add(data);
        }

        closeFormModal();
        await loadPoems();
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤—ñ—Ä—à–∞:", error);
        showError("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ—Ä—à. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.");
      } finally {
        hideLoader();
      }
    }

    // –í–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ—Ä—à
    async function deletePoem() {
      if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ—Ä—à?')) return;
      showLoader();
      try {
        await db.collection('poems').doc(currentPoemId).delete();
        closeModal();
        await loadPoems();
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤—ñ—Ä—à–∞:", error);
        showError("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ—Ä—à.");
      } finally {
        hideLoader();
      }
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞—É–¥—ñ–æ
    async function uploadAudio(file) {
      if (!supabaseClient) throw new Error('Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π');

      // –û—Ç—Ä–∏–º—É—î–º–æ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É
      const fileExtension = file.name.split('.').pop().toLowerCase();
      const extension = ['mp3', 'wav', 'ogg'].includes(fileExtension) ? fileExtension : 'mp3';
      const fileName = `poems/${Date.now()}_${Date.now()}.${extension}`; // –£–Ω–∏–∫–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ—Ö —ñ–º–µ–Ω

      const { data, error } = await supabaseClient.storage.from('poetry-audio').upload(fileName, file);
      if (error) throw error;

      const { data: { publicUrl } } = supabaseClient.storage.from('poetry-audio').getPublicUrl(data.path);
      console.log("–ê—É–¥—ñ–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:", publicUrl); // –î–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
      return publicUrl;
    }

    // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–º–∏–ª–∫—É
    function showError(message) {
      alert(message);
    }

    // –ó–º—ñ–Ω–∞ —à—Ä–∏—Ñ—Ç—É
    function changeFont(font) {
      document.body.style.fontFamily = font;
      if (window.localStorage) window.localStorage.setItem('selectedFont', font);
      document.querySelectorAll('.font-option').forEach(o => o.classList.remove('active'));
      const active = document.querySelector(`.font-option[data-font="${font}"]`);
      if (active) active.classList.add('active');
    }

    // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await initializeFirebase();
        await initializeSupabase();
        createPetals();
        await loadPoems();

        // –®—Ä–∏—Ñ—Ç
        const savedFont = localStorage.getItem('selectedFont');
        if (savedFont) changeFont(savedFont);

        // –ì—É—á–Ω—ñ—Å—Ç—å
        const volumeSlider = document.getElementById('volumeSlider');
        const savedVolume = localStorage.getItem('volume');
        if (savedVolume) volumeSlider.value = savedVolume;
        volumeSlider.addEventListener('input', e => {
          const vol = e.target.value;
          localStorage.setItem('volume', vol);
          document.querySelectorAll('audio').forEach(a => a.volume = vol);
        });

        // –ö–Ω–æ–ø–∫–∏
        document.getElementById('addPoemBtn').onclick = () => {
          currentPoemId = null;
          openFormModal(false);
        };

        document.getElementById('editPoemBtnModal').onclick = () => {
          closeModal();
          openFormModal(true);
        };

        document.getElementById('deletePoemBtnModal').onclick = deletePoem;

        document.getElementById('submitForm').onclick = savePoem;

        // –í–∏–±—ñ—Ä —à—Ä–∏—Ñ—Ç—ñ–≤
        const fontSelector = document.getElementById('fontSelector');
        const fontOptions = document.getElementById('fontOptions');
        fontSelector.onclick = () => fontOptions.classList.toggle('show');
        document.querySelectorAll('.font-option').forEach(option => {
          option.onclick = () => {
            changeFont(option.dataset.font);
            fontOptions.classList.remove('show');
          };
        });
        document.addEventListener('click', e => {
          if (!e.target.closest('#fontSelector') && !e.target.closest('#fontOptions')) {
            fontOptions.classList.remove('show');
          }
        });
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –¥–æ–¥–∞—Ç–∫–∞:", error);
        showError("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.");
      }
    });

    function showLoader() {
      document.getElementById('loader').style.transform = 'scaleX(0.7)';
    }
    function hideLoader() {
      document.getElementById('loader').style.transform = 'scaleX(0)';
    }
  </script>
</body>
</html>